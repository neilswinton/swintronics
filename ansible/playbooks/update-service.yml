---
- name: Update Docker Service
  hosts: "{{ target_host | default('swintronics') }}"
  become: yes
  
  pre_tasks:
    - name: Fetch all secrets from Infisical
      shell: |
        infisical export --projectId="{{ infisical_project_id }}" --env={{ infisical_environment }} --format=dotenv-export
      register: infisical_secrets_raw
      delegate_to: localhost
      changed_when: false
      
    - name: Parse secrets into dictionary
      set_fact:
        secrets: "{{ infisical_secrets_raw.stdout | regex_findall('export ([^=]+)=\"([^\"]+)\"') | items2dict }}"
  
  vars:
    # These will be set in Semaphore or command line
    service_name: ""  # e.g., immich, paperless, kuma
    new_version: ""   # e.g., v1.117.0
    
    # Infisical configuration
    infisical_project_id: "Swintronics Runtime"
    infisical_environment: "dev"
    
    # Map service names to directory names
    service_directory_map:
      immich: "immich-app"
      paperless: "paperless"
      kuma: "uptime-kuma"
      stirling-pdf: "sterling-pdf"
      linkwarden: "linkwarden"
      dozzle: "dozzle"
      traefik: "networking"
    
    # Get actual directory name
    service_directory: "{{ service_directory_map[service_name] | default(service_name) }}"
    
    # Service paths
    service_path: "{{ docker_services_path }}/{{ service_directory }}"
    
    # Whether to stop/start Kuma (skip if we're updating Kuma itself)
    manage_kuma: "{{ service_name != 'kuma' }}"
    
  tasks:
    - name: Validate required variables
      fail:
        msg: "service_name and new_version are required"
      when: service_name == "" or new_version == ""
    
    - name: Pause healthchecks.io monitor
      uri:
        url: "https://healthchecks.io/api/v3/checks/{{ secrets.HEALTHCHECKS_KUMA_CHECK_UUID }}/pause"
        method: POST
        headers:
          X-Api-Key: "{{ secrets.HEALTHCHECKS_API_KEY }}"
        status_code: 200
      delegate_to: localhost
      
    - name: Stop Uptime Kuma container
      community.docker.docker_compose:
        project_src: "{{ docker_services_path }}/uptime-kuma"
        state: absent
      when: manage_kuma | bool
      
    - name: Backup current .env file
      copy:
        src: "{{ service_path }}/.env"
        dest: "{{ service_path }}/.env.backup-{{ ansible_date_time.iso8601_basic_short }}"
        remote_src: yes
        
    - name: Update version in .env file
      lineinfile:
        path: "{{ service_path }}/.env"
        regexp: "^{{ service_name | upper | replace('-', '_') }}_VERSION=.*"
        line: "{{ service_name | upper | replace('-', '_') }}_VERSION={{ new_version }}"
        
    - name: Pull new Docker image
      community.docker.docker_compose:
        project_src: "{{ service_path }}"
        pull: yes
        
    - name: Restart service with new version
      community.docker.docker_compose:
        project_src: "{{ service_path }}"
        restarted: yes
        
    - name: Wait for container to be running
      community.docker.docker_container_info:
        name: "{{ service_name }}"
      register: container_info
      until: container_info.exists and container_info.container.State.Running
      retries: 30
      delay: 2
      
    - name: Start Uptime Kuma container
      community.docker.docker_compose:
        project_src: "{{ docker_services_path }}/uptime-kuma"
        state: present
      when: manage_kuma | bool
      
    - name: Wait for Kuma to be ready
      wait_for:
        port: 3001
        delay: 5
        timeout: 60
      when: manage_kuma | bool
      
    - name: Resume healthchecks.io monitor
      uri:
        url: "https://healthchecks.io/api/v3/checks/{{ secrets.HEALTHCHECKS_KUMA_CHECK_UUID }}/resume"
        method: POST
        headers:
          X-Api-Key: "{{ secrets.HEALTHCHECKS_API_KEY }}"
        status_code: 200
      delegate_to: localhost
      
    - name: Display update summary
      debug:
        msg: |
          âœ… {{ service_name }} successfully updated to {{ new_version }}
          Container is running and healthy
